<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš€ Bitget Trading System v3.0 - ê°„ë‹¨ ëŒ€ì‹œë³´ë“œ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0a0a; color: #ffffff; padding: 20px;
        }
        .header { 
            background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 2rem;
            border-left: 4px solid #00d4aa;
        }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; }
        .card { 
            background: #1a1a1a; padding: 1rem; border-radius: 8px; 
            border: 1px solid #333; position: relative;
        }
        .card h3 { color: #00d4aa; margin-bottom: 1rem; }
        .status { 
            display: inline-block; padding: 4px 12px; border-radius: 20px; 
            font-size: 0.875rem; margin-bottom: 0.5rem;
        }
        .status.running { background: #00d4aa; color: #000; }
        .status.error { background: #ff4444; color: #fff; }
        .loading { color: #888; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #333; }
        th { color: #00d4aa; }
        .refresh-btn { 
            background: #00d4aa; color: #000; border: none; padding: 8px 16px; 
            border-radius: 4px; cursor: pointer; margin-bottom: 1rem;
        }
        .refresh-btn:hover { background: #00b090; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸš€ Bitget Trading System v3.0</h1>
        <p>ì‹¤ì‹œê°„ ê±°ë˜ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</p>
    </div>

    <div class="grid">
        <div class="card">
            <h3>ì‹œìŠ¤í…œ ìƒíƒœ</h3>
            <div id="system-status" class="loading">ë¡œë”© ì¤‘...</div>
            <button class="refresh-btn" onclick="refreshData()">ìƒˆë¡œê³ ì¹¨</button>
        </div>

        <div class="card">
            <h3>í˜„ì¬ í¬ì§€ì…˜</h3>
            <div id="positions-data" class="loading">ë¡œë”© ì¤‘...</div>
        </div>

        <div class="card">
            <h3>ì”ê³  ì •ë³´</h3>
            <div id="balance-data" class="loading">ë¡œë”© ì¤‘...</div>
        </div>

        <div class="card">
            <h3>ìµœê·¼ ê±°ë˜</h3>
            <div id="trades-data" class="loading">ë¡œë”© ì¤‘...</div>
        </div>
    </div>

    <script>
        let refreshInterval;

        async function fetchData(endpoint) {
            try {
                const response = await fetch(`/api/${endpoint}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`${endpoint} ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:`, error);
                return { error: error.message };
            }
        }

        async function refreshData() {
            console.log('ë°ì´í„° ìƒˆë¡œê³ ì¹¨...');

            // ì‹œìŠ¤í…œ ìƒíƒœ
            const statusEl = document.getElementById('system-status');
            try {
                const status = await fetchData('dashboard');
                if (status.error) {
                    statusEl.innerHTML = `<div class="status error">ì˜¤ë¥˜: ${status.error}</div>`;
                } else {
                    const wsStatus = status.system_status?.websocket_connected ? 'ì—°ê²°ë¨' : 'ì—°ê²° ëŠê¹€';
                    statusEl.innerHTML = `
                        <div class="status running">ì‹œìŠ¤í…œ ê°€ë™ ì¤‘</div>
                        <p>WebSocket: ${wsStatus}</p>
                        <p>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleTimeString()}</p>
                    `;
                }
            } catch (error) {
                statusEl.innerHTML = `<div class="status error">ì‹œìŠ¤í…œ ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨</div>`;
            }

            // í¬ì§€ì…˜ ì •ë³´
            const positionsEl = document.getElementById('positions-data');
            try {
                const positions = await fetchData('dashboard');
                if (positions.positions && positions.positions.length > 0) {
                    let html = '<table><tr><th>ì¢…ëª©</th><th>ë°©í–¥</th><th>ìˆ˜ëŸ‰</th><th>ì†ìµ</th></tr>';
                    positions.positions.forEach(pos => {
                        const pnl = pos.unrealized_pnl || 0;
                        const pnlColor = pnl >= 0 ? '#00d4aa' : '#ff4444';
                        html += `<tr>
                            <td>${pos.symbol}</td>
                            <td>${pos.side}</td>
                            <td>${pos.quantity}</td>
                            <td style="color: ${pnlColor}">${pnl.toFixed(2)}%</td>
                        </tr>`;
                    });
                    html += '</table>';
                    positionsEl.innerHTML = html;
                } else {
                    positionsEl.innerHTML = '<p>í™œì„± í¬ì§€ì…˜ ì—†ìŒ</p>';
                }
            } catch (error) {
                positionsEl.innerHTML = '<p>í¬ì§€ì…˜ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</p>';
            }

            // ì”ê³  ì •ë³´
            const balanceEl = document.getElementById('balance-data');
            try {
                const balance = await fetchData('balance');
                if (balance.error) {
                    balanceEl.innerHTML = `<p>ì”ê³  ì¡°íšŒ ì‹¤íŒ¨: ${balance.error}</p>`;
                } else {
                    balanceEl.innerHTML = `
                        <p>ì´ ì”ê³ : $${balance.total_balance?.toFixed(2) || '0.00'}</p>
                        <p>ê°€ìš© ì”ê³ : $${balance.free_balance?.toFixed(2) || '0.00'}</p>
                        <p>ì‚¬ìš© ì¤‘: $${balance.used_balance?.toFixed(2) || '0.00'}</p>
                        <p>í¬ì§€ì…˜ ìˆ˜: ${balance.open_positions || 0}ê°œ</p>
                    `;
                }
            } catch (error) {
                balanceEl.innerHTML = '<p>ì”ê³  ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</p>';
            }

            // ìµœê·¼ ê±°ë˜
            const tradesEl = document.getElementById('trades-data');
            try {
                const trades = await fetchData('dashboard');
                if (trades.recent_trades && trades.recent_trades.length > 0) {
                    let html = '<table><tr><th>ì‹œê°„</th><th>ì¢…ëª©</th><th>ë°©í–¥</th><th>ì†ìµ</th></tr>';
                    trades.recent_trades.slice(0, 5).forEach(trade => {
                        const time = new Date(trade.timestamp).toLocaleTimeString();
                        const pnl = trade.pnl || 0;
                        const pnlColor = pnl >= 0 ? '#00d4aa' : '#ff4444';
                        html += `<tr>
                            <td>${time}</td>
                            <td>${trade.symbol}</td>
                            <td>${trade.side}</td>
                            <td style="color: ${pnlColor}">${pnl.toFixed(2)}%</td>
                        </tr>`;
                    });
                    html += '</table>';
                    tradesEl.innerHTML = html;
                } else {
                    tradesEl.innerHTML = '<p>ìµœê·¼ ê±°ë˜ ì—†ìŒ</p>';
                }
            } catch (error) {
                tradesEl.innerHTML = '<p>ê±°ë˜ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</p>';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¡œë“œ
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ ê°„ë‹¨ ëŒ€ì‹œë³´ë“œ ì‹œì‘');
            refreshData();
            
            // 30ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
            refreshInterval = setInterval(refreshData, 30000);
        });

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì¸í„°ë²Œ ì •ë¦¬
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) clearInterval(refreshInterval);
        });
    </script>
</body>
</html>